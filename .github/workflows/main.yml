name: Executar PowerShell e Exportar Procedures

on:
  push:
    branches:
      - main

jobs:
  run_powershell:
    runs-on: windows-latest  # Usa o runner do Windows, onde o PowerShell é nativo

    steps:
      - name: Check out o repositório
        uses: actions/checkout@v2  # Faz o checkout do código

      - name: Executar comandos PowerShell
        shell: pwsh  # Especifica que o shell a ser usado será o PowerShell (pwsh para PowerShell Core)
        run: |
          Write-Host "Executando PowerShell no GitHub Actions!"
          # (conteúdo omitido para manter o foco nos ajustes solicitados)

  export_mysql_procedures:
    runs-on: ubuntu-latest  # Usa o runner do Linux para executar o script MySQL

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Export MySQL Procedures
        env:
          MYSQL_HOST: 179.188.16.101
          MYSQL_USER: cabr_pdv
          MYSQL_PASSWORD: P@ssw0rd013459
          MYSQL_DATABASE: cabr_pdv
        run: |
          # Instalar cliente MySQL
          sudo apt-get update && sudo apt-get install -y mysql-client
          # Diretório para salvar as procedures
          EXPORT_DIR="procedures"
          mkdir -p $EXPORT_DIR
          # Obter lista de procedures
          mysql -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_PASSWORD -D $MYSQL_DATABASE -N -e "
          SELECT ROUTINE_NAME 
          FROM INFORMATION_SCHEMA.ROUTINES 
          WHERE ROUTINE_TYPE = 'PROCEDURE' AND ROUTINE_SCHEMA = '$MYSQL_DATABASE';
          " > procedure_list.txt
          # Exportar cada procedure para um arquivo individual
          while read procedure; do
            echo "Exportando procedure: $procedure"
            mysql -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_PASSWORD -D $MYSQL_DATABASE -N -e "
            SHOW CREATE PROCEDURE \`$procedure\`\G" > "$EXPORT_DIR/$procedure.sql" 2>/dev/null || \
            echo "Erro ao exportar procedure: $procedure. Continuando..."
          done < procedure_list.txt
          # Remover arquivo temporário
          rm procedure_list.txt

      - name: Criação de novo branch e commit das alterações
        run: |
          # Configuração do usuário Git
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # Cria um novo branch
          TIMESTAMP=$(date +"%Y-%m-%d-%H-%M-%S")
          git checkout -b export-procedures-$TIMESTAMP
          
          # Adiciona e comita as alterações
          git add procedures
          git commit -m "Exportação automática de procedures: $TIMESTAMP"
          
          # Push do novo branch usando o GitHub Actions token padrão
          git push https://github.com/41isonm/interacti.js.git HEAD:export-procedures-$TIMESTAMP
